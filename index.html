<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant Menu</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-center mb-8">Our Menu</h1>
    <div class="flex justify-end mb-4 space-x-2">
      <button id="view-order" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 disabled:bg-gray-400" disabled>View Order (0)</button>
      <button id="view-posts" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">View Posts</button>
    </div>
    <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <!-- Modal for Nutritional Data -->
  <div id="nutrition-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Nutritional Information</h2>
      <div id="nutrition-content"></div>
      <div id="ingredients-list" class="mt-4"></div>
      <div class="mt-4 flex space-x-2">
        <button id="recalculate-nutrition" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-400" disabled>Recalculate Nutrition</button>
        <button id="add-to-order" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Add to Order</button>
        <button id="close-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal for Order Summary -->
  <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Order Summary</h2>
      <div id="order-content"></div>
      <div class="mt-4 flex space-x-2">
        <button id="clear-order" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Clear Order</button>
        <button id="close-order-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Close</button>
      </div>
    </div>
  </div>

  <!-- Modal for Creating Post -->
  <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Create Post</h2>
      <form id="post-form">
        <div class="mb-4">
          <label for="post-quote" class="block text-gray-700 font-semibold mb-2">Quote Text (<100 characters)</label>
          <input type="text" id="post-quote" class="w-full p-2 border rounded" maxlength="100" readonly>
        </div>
        <div class="mb-4">
          <label for="post-name" class="block text-gray-700 font-semibold mb-2">Your Name</label>
          <input type="text" id="post-name" class="w-full p-2 border rounded" required>
        </div>
        <div class="mb-4">
          <label for="post-message" class="block text-gray-700 font-semibold mb-2">Message (<500 characters)</label>
          <textarea id="post-message" class="w-full p-2 border rounded" maxlength="500"></textarea>
          <p class="text-gray-600 text-sm"><span id="message-char-count">0</span>/500 characters</p>
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">Post</button>
          <button type="button" id="close-post-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Viewing Posts -->
  <div id="posts-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Community Posts</h2>
      <div id="posts-content"></div>
      <div class="mt-4">
        <button id="close-posts-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Close</button>
      </div>
    </div>
  </div>

  <script>
    // JSON data embedded directly
    const menuData = {
      "analyzed_items": [
        {
          "name": "Jerk Chicken Dinner",
          "type": "Dish",
          "restaurant description": "Jerk chicken made with our signature spices and sauce, on rice & peas and cabbage.",
          "6-12 word description": "Spicy jerk chicken with rice, cabbage.",
          "price": "12.99",
          "tags": ["high-protein", "gluten-free", "dairy-free"],
          "ingredients": ["chicken", "rice", "peas", "cabbage", "allspice", "thyme", "scotch bonnet peppers"],
          "allergens": ["chicken"],
          "add-ons": [],
          "substitutions": [],
          "verified": "no"
        },
        {
          "name": "Fried Plantain",
          "type": "Side",
          "restaurant description": "Fried yellow sweet plantains. Vegetarian.",
          "12 word description": "Crispy fried sweet plantains, vegetarian and gluten-free.",
          "tags": ["vegetarian", "high-carb", "gluten-free"],
          "ingredients": ["plaintain", "oil"],
          "allergens": [],
          "add-ons": [],
          "substitutions": [],
          "verified": "no"
        },
        {
          "name": "Oxtail Dinner",
          "type": "Dish",
          "restaurant description": "Oxtails stewed in a blend of spices and herbs, carrots, beans, spinners (mini dumplings), on rice & peas and cabbage.",
          "12 word description": "Savory oxtail stew with spices, herbs, carrots, beans, and mini dumplings, served over rice & peas with cabbage.",
          "tags": ["high-protein", "high-fat"],
          "ingredients": ["oxtail", "carrots", "beans", "dumplings", "rice", "peas", "cabbage", "spices", "herbs"],
          "allergens": [],
          "add-ons": [],
          "substitutions": [],
          "verified": "no"
        },
        {
          "name": "Curried Chicken Dinner",
          "type": "Dish",
          "restaurant description": "Chicken simmered in our special curry blend, on rice & peas and cabbage. *dark meat",
          "12 word description": "Curried dark meat chicken, rice, cabbage.",
          "tags": ["high-protein", "gluten-free", "dairy-free"],
          "ingredients": ["chicken", "curry powder", "rice", "peas", "cabbage"],
          "allergens": [],
          "add-ons": [],
          "substitutions": [],
          "verified": "no"
        },
        {
          "name": "Sorrel Bottled",
          "type": "Drink",
          "restaurant description": "House blend of Jamaican (Hibiscus) Sorrel and fresh ginger. Still our homemade drink, now being bottled in house.",
          "12 word description": "Refreshing Jamaican hibiscus-ginger drink, bottled.",
          "tags": ["vegan", "vegetarian", "gluten-free", "dairy-free", "low-carb"],
          "ingredients": ["sorrel", "ginger", "water"],
          "allergens": [],
          "add-ons": [],
          "substitutions": [],
          "verified": "no"
        }
      ]
    };

    // Nutritionix API credentials (replace with your own)
    const APP_ID = '7688c68f';
    const APP_KEY = '5b73c9212b1cd6df81b92bc862575f9f';

    // Order state
    let order = [];

    // Function to render menu items
    function renderMenu() {
      const container = document.getElementById('menu-container');
      menuData.analyzed_items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-lg shadow-md';
        card.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">${item.name}</h2>
          <p class="text-gray-600 mb-2">${item['6-12 word description']}</p>
          <p class="text-gray-800 font-bold mb-2">$${item.price}</p>
          <p class="text-gray-600 mb-2"><strong>Type:</strong> ${item.type}</p>
          <p class="text-gray-600 mb-2"><strong>Tags:</strong> ${item.tags.join(', ')}</p>
          <p class="text-gray-600 mb-2"><strong>Ingredients:</strong> ${item.ingredients.join(', ')}</p>
          <p class="text-gray-600 mb-4"><strong>Allergens:</strong> ${item.allergens.length ? item.allergens.join(', ') : 'None'}</p>
          <div class="flex space-x-2">
            <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 get-nutrition" data-item='${JSON.stringify(item)}'>Get Nutrition Info</button>
            <button class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 post-item" data-item='${JSON.stringify(item)}'>Post</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Function to fetch and aggregate nutritional data from Nutritionix API
    async function fetchNutritionData(ingredients) {
      if (!ingredients || ingredients.length === 0) {
        return null;
      }
      const query = ingredients.join(', ');
      const settings = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-app-id': APP_ID,
          'x-app-key': APP_KEY,
          'x-remote-user-id': '0'
        },
        body: JSON.stringify({
          query: query,
          num_servings: 1,
          line_delimited: false,
          use_raw_foods: false,
          include_subrecipe: false,
          timezone: 'US/Eastern',
          locale: 'en_US'
        })
      };

      try {
        const response = await fetch('https://trackapi.nutritionix.com/v2/natural/nutrients', settings);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();

        // Aggregate nutritional data across all foods
        const aggregatedData = data.foods.reduce((acc, food) => ({
          nf_calories: (acc.nf_calories || 0) + (food.nf_calories || 0),
          nf_protein: (acc.nf_protein || 0) + (food.nf_protein || 0),
          nf_total_fat: (acc.nf_total_fat || 0) + (food.nf_total_fat || 0),
          nf_dietary_fiber: (acc.nf_dietary_fiber || 0) + (food.nf_dietary_fiber || 0)
        }), {});

        return aggregatedData;
      } catch (error) {
        console.error('Error fetching nutrition data:', error);
        return null;
      }
    }

    // Function to send meal data to backend
    async function saveMealToBackend(meal) {
      try {
        const response = await fetch('http://localhost:3000/api/meals', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(meal)
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const result = await response.json();
        console.log('Meal saved to database:', result);
        return true;
      } catch (error) {
        console.error('Error saving meal to backend:', error);
        alert('Failed to save meal to database. Please try again.');
        return false;
      }
    }

    // Function to send post data to backend
    async function savePostToBackend(post) {
      try {
        const response = await fetch('http://localhost:3000/api/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(post)
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const result = await response.json();
        console.log('Post saved to database:', result);
        return true;
      } catch (error) {
        console.error('Error saving post to backend:', error);
        alert('Failed to save post. Please try again.');
        return false;
      }
    }

    // Function to fetch posts from backend
    async function fetchPosts() {
      try {
        const response = await fetch('http://localhost:3000/api/posts');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const posts = await response.json();
        return posts;
      } catch (error) {
        console.error('Error fetching posts:', error);
        alert('Failed to load posts. Please try again.');
        return [];
      }
    }

    // Function to display nutritional data and ingredients in modal
    function showNutritionModal(nutritionData, itemName, ingredients) {
      const modal = document.getElementById('nutrition-modal');
      const content = document.getElementById('nutrition-content');
      const ingredientsList = document.getElementById('ingredients-list');
      const recalculateButton = document.getElementById('recalculate-nutrition');
      const addToOrderButton = document.getElementById('add-to-order');

      // Store current item data for "Add to Order"
      addToOrderButton.dataset.itemName = itemName;
      addToOrderButton.dataset.nutrition = JSON.stringify(nutritionData || {});
      addToOrderButton.dataset.ingredients = JSON.stringify(ingredients);

      // Display nutritional data
      if (!nutritionData) {
        content.innerHTML = `<p class="text-red-600">Unable to fetch nutritional data for ${itemName}. Please try again later.</p>`;
        addToOrderButton.disabled = true;
      } else {
        content.innerHTML = `
          <p><strong>Item:</strong> ${itemName}</p>
          <p><strong>Calories:</strong> ${nutritionData.nf_calories ? nutritionData.nf_calories.toFixed(1) : 'N/A'} kcal</p>
          <p><strong>Protein:</strong> ${nutritionData.nf_protein ? nutritionData.nf_protein.toFixed(1) : 'N/A'} g</p>
          <p><strong>Total Fat:</strong> ${nutritionData.nf_total_fat ? nutritionData.nf_total_fat.toFixed(1) : 'N/A'} g</p>
          <p><strong>Dietary Fiber:</strong> ${nutritionData.nf_dietary_fiber ? nutritionData.nf_dietary_fiber.toFixed(1) : 'N/A'} g</p>
        `;
        addToOrderButton.disabled = false;
      }

      // Display ingredients with checkboxes
      ingredientsList.innerHTML = '<p class="font-semibold mb-2">Select Ingredients:</p>';
      if (ingredients.length === 0) {
        ingredientsList.innerHTML += '<p class="text-gray-600">No ingredients available.</p>';
        recalculateButton.disabled = true;
      } else {
        ingredients.forEach(ingredient => {
          const div = document.createElement('div');
          div.className = 'flex items-center';
          div.innerHTML = `
            <input type="checkbox" id="ing-${ingredient}" value="${ingredient}" class="mr-2 ingredient-checkbox" checked>
            <label for="ing-${ingredient}">${ingredient}</label>
          `;
          ingredientsList.appendChild(div);
        });
        recalculateButton.disabled = false;
      }

      modal.classList.remove('hidden');
    }

    // Function to display order summary in modal
    function showOrderModal() {
      const modal = document.getElementById('order-modal');
      const content = document.getElementById('order-content');

      if (order.length === 0) {
        content.innerHTML = '<p class="text-gray-600">Your order is empty.</p>';
      } else {
        // Calculate total nutrition
        const totalNutrition = order.reduce((acc, item) => {
          if (!item.nutrition) return acc;
          return {
            nf_calories: (acc.nf_calories || 0) + (item.nutrition.nf_calories || 0),
            nf_protein: (acc.nf_protein || 0) + (item.nutrition.nf_protein || 0),
            nf_total_fat: (acc.nf_total_fat || 0) + (item.nutrition.nf_total_fat || 0),
            nf_dietary_fiber: (acc.nf_dietary_fiber || 0) + (item.nutrition.nf_dietary_fiber || 0)
          };
        }, {});

        // Generate content
        let html = '<h3 class="font-semibold mb-2">Total Nutrition</h3>';
        html += `
          <p><strong>Calories:</strong> ${totalNutrition.nf_calories ? totalNutrition.nf_calories.toFixed(1) : 'N/A'} kcal</p>
          <p><strong>Protein:</strong> ${totalNutrition.nf_protein ? totalNutrition.nf_protein.toFixed(1) : 'N/A'} g</p>
          <p><strong>Total Fat:</strong> ${totalNutrition.nf_total_fat ? totalNutrition.nf_total_fat.toFixed(1) : 'N/A'} g</p>
          <p><strong>Dietary Fiber:</strong> ${totalNutrition.nf_dietary_fiber ? totalNutrition.nf_dietary_fiber.toFixed(1) : 'N/A'} g</p>
          <h3 class="font-semibold mt-4 mb-2">Order Details</h3>
        `;

        order.forEach((item, index) => {
          html += `
            <div class="mb-4">
              <p><strong>Meal ${index + 1}: ${item.name}</strong></p>
              <p><strong>Ingredients:</strong> ${item.ingredients.length ? item.ingredients.join(', ') : 'None'}</p>
              <p><strong>Calories:</strong> ${item.nutrition && item.nutrition.nf_calories ? item.nutrition.nf_calories.toFixed(1) : 'N/A'} kcal</p>
              <p><strong>Protein:</strong> ${item.nutrition && item.nutrition.nf_protein ? item.nutrition.nf_protein.toFixed(1) : 'N/A'} g</p>
              <p><strong>Total Fat:</strong> ${item.nutrition && item.nutrition.nf_total_fat ? item.nutrition.nf_total_fat.toFixed(1) : 'N/A'} g</p>
              <p><strong>Dietary Fiber:</strong> ${item.nutrition && item.nutrition.nf_dietary_fiber ? item.nutrition.nf_dietary_fiber.toFixed(1) : 'N/A'} g</p>
            </div>
          `;
        });

        content.innerHTML = html;
      }

      modal.classList.remove('hidden');
    }

    // Function to show post modal
    function showPostModal(item) {
      const modal = document.getElementById('post-modal');
      const quoteInput = document.getElementById('post-quote');
      const nameInput = document.getElementById('post-name');
      const messageInput = document.getElementById('post-message');
      const charCount = document.getElementById('message-char-count');

      // Generate default quote text (<100 characters)
      const shortDesc = item['6-12 word description'].split(' ').slice(0, 4).join(' ');
      const quoteText = `"${item.name}: ${shortDesc}..."`;
      quoteInput.value = quoteText.length > 100 ? quoteText.slice(0, 97) + '...' : quoteText;

      // Reset form
      nameInput.value = '';
      messageInput.value = '';
      charCount.textContent = '0';

      // Store item name for posting
      document.getElementById('post-form').dataset.itemName = item.name;

      modal.classList.remove('hidden');
    }

    // Function to show posts modal
    async function showPostsModal() {
      const modal = document.getElementById('posts-modal');
      const content = document.getElementById('posts-content');
      const posts = await fetchPosts();

      if (posts.length === 0) {
        content.innerHTML = '<p class="text-gray-600">No posts yet.</p>';
      } else {
        let html = '';
        posts.forEach(post => {
          html += `
            <div class="mb-4 border-b pb-4">
              <p><strong>${post.user_name}</strong> on ${new Date(post.created_at).toLocaleString()}</p>
              <p class="italic">${post.quote_text}</p>
              <p><strong>Meal:</strong> ${post.meal_name}</p>
              <p>${post.message || 'No message'}</p>
            </div>
          `;
        });
        content.innerHTML = html;
      }

      modal.classList.remove('hidden');
    }

    // Function to update View Order button
    function updateViewOrderButton() {
      const button = document.getElementById('view-order');
      button.textContent = `View Order (${order.length})`;
      button.disabled = order.length === 0;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      renderMenu();
      updateViewOrderButton();

      // Handle nutrition button clicks
      document.querySelectorAll('.get-nutrition').forEach(button => {
        button.addEventListener('click', async () => {
          const item = JSON.parse(button.dataset.item);
          const nutritionData = await fetchNutritionData(item.ingredients);
          showNutritionModal(nutritionData, item.name, item.ingredients);
        });
      });

      // Handle post button clicks
      document.querySelectorAll('.post-item').forEach(button => {
        button.addEventListener('click', () => {
          const item = JSON.parse(button.dataset.item);
          showPostModal(item);
        });
      });

      // Handle post form submission
      document.getElementById('post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemName = e.target.dataset.itemName;
        const quoteText = document.getElementById('post-quote').value;
        const userName = document.getElementById('post-name').value.trim();
        const message = document.getElementById('post-message').value.trim();

        if (!userName) {
          alert('Please enter your name.');
          return;
        }

        const post = {
          meal_name: itemName,
          quote_text: quoteText,
          user_name: userName,
          message: message || null
        };

        const saved = await savePostToBackend(post);
        if (saved) {
          document.getElementById('post-modal').classList.add('hidden');
        }
      });

      // Handle message character count
      document.getElementById('post-message').addEventListener('input', () => {
        const message = document.getElementById('post-message').value;
        document.getElementById('message-char-count').textContent = message.length;
      });

      // Handle recalculate nutrition
      document.getElementById('recalculate-nutrition').addEventListener('click', async () => {
        const checkboxes = document.querySelectorAll('.ingredient-checkbox:checked');
        const selectedIngredients = Array.from(checkboxes).map(cb => cb.value);
        const itemName = document.querySelector('#nutrition-content p:first-child').textContent.replace('Item: ', '');

        if (selectedIngredients.length === 0) {
          showNutritionModal(null, itemName, selectedIngredients);
          return;
        }

        const recalculateButton = document.getElementById('recalculate-nutrition');
        recalculateButton.disabled = true;
        recalculateButton.textContent = 'Calculating...';

        const nutritionData = await fetchNutritionData(selectedIngredients);

        recalculateButton.disabled = false;
        recalculateButton.textContent = 'Recalculate Nutrition';

        showNutritionModal(nutritionData, itemName, selectedIngredients);
      });

      // Handle add to order
      document.getElementById('add-to-order').addEventListener('click', async () => {
        const button = document.getElementById('add-to-order');
        const itemName = button.dataset.itemName;
        const nutritionData = JSON.parse(button.dataset.nutrition);
        const ingredients = JSON.parse(button.dataset.ingredients);

        const meal = {
          name: itemName,
          ingredients: ingredients,
          calories: nutritionData.nf_calories ? nutritionData.nf_calories.toFixed(1) : null,
          protein: nutritionData.nf_protein ? nutritionData.nf_protein.toFixed(1) : null,
          fat: nutritionData.nf_total_fat ? nutritionData.nf_total_fat.toFixed(1) : null,
          fiber: nutritionData.nf_dietary_fiber ? nutritionData.nf_dietary_fiber.toFixed(1) : null
        };

        // Send to backend
        const saved = await saveMealToBackend(meal);
        if (!saved) return; // Stop if backend save fails

        // Add to local order
        order.push({
          name: itemName,
          ingredients: ingredients,
          nutrition: nutritionData
        });

        updateViewOrderButton();
        document.getElementById('nutrition-modal').classList.add('hidden');
      });

      // Handle view order
      document.getElementById('view-order').addEventListener('click', () => {
        showOrderModal();
      });

      // Handle view posts
      document.getElementById('view-posts').addEventListener('click', () => {
        showPostsModal();
      });

      // Handle clear order
      document.getElementById('clear-order').addEventListener('click', () => {
        order = [];
        updateViewOrderButton();
        showOrderModal();
      });

      // Close nutrition modal
      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('nutrition-modal').classList.add('hidden');
      });

      // Close order modal
      document.getElementById('close-order-modal').addEventListener('click', () => {
        document.getElementById('order-modal').classList.add('hidden');
      });

      // Close post modal
      document.getElementById('close-post-modal').addEventListener('click', () => {
        document.getElementById('post-modal').classList.add('hidden');
      });

      // Close posts modal
      document.getElementById('close-posts-modal').addEventListener('click', () => {
        document.getElementById('posts-modal').classList.add('hidden');
      });
    });
  </script>
</body>
</html>